<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë‘ë”ì§€ ì¡ê¸° ê²Œì„(Made By Halam)</title>

  <style>
    :root{
      --bg:#121621; --hole:#1e2332; --mole:#d25f5f; --mole-shadow:#783737;
      --white:#ffffff; --red:#e66e6e; --hud:#eaeaf0; --accent:#ffd974;
      --glass: rgba(255,255,255,.06);
    }
    html,body{
      margin:0; height:100%;
      background:linear-gradient(180deg,#0f1320,#121621);
      color:var(--hud);
      font-family:system-ui,"Noto Sans KR",sans-serif;
    }
    .wrap{display:flex;gap:24px;justify-content:center;align-items:center;padding:24px;flex-wrap:wrap}
    canvas{width:min(640px,92vw);aspect-ratio:640/720;border-radius:16px;background:#121621}
    .panel{width:380px;background:var(--glass);border-radius:16px;padding:16px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,.1)}
    .hint{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);font-size:12px;opacity:.8}
    .overlay{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.5)}
    .dialog{background:#192033;padding:20px;border-radius:14px;width:320px}
    input,button{padding:10px;border-radius:8px;border:none}
    button{cursor:pointer}
  </style>
</head>

<body>
<div class="wrap">
  <canvas id="game" width="640" height="720"></canvas>

  <div class="panel">
    <h2>ğŸ† ë¦¬ë”ë³´ë“œ (Top 10)</h2>
    <table>
      <thead>
        <tr><th>#</th><th>ë‹‰ë„¤ì„</th><th>ì ìˆ˜</th></tr>
      </thead>
      <tbody id="board-body">
        <tr><td colspan="3">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="hint">Space ì‹œì‘ Â· í´ë¦­ ê³µê²© Â· R ì¬ì‹œì‘</div>

<!-- ë‹‰ë„¤ì„ ì…ë ¥ -->
<div class="overlay" id="overlay">
  <div class="dialog">
    <h3>ğŸ‰ TOP10 ì§„ì…!</h3>
    <input id="nickname" placeholder="ë‹‰ë„¤ì„ (2~12ì)">
    <br><br>
    <button id="save">ì €ì¥</button>
  </div>
</div>

<script>
/* ================= ê¸°ë³¸ ì„¤ì • ================= */
const W=640,H=720;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let state="menu";
let score=0, combo=0, maxCombo=0;
let time=30, elapsed=0;
let pendingScore=null;

/* ================= ë‘ë”ì§€ ================= */
const moles=[];
for(let y=0;y<3;y++){
  for(let x=0;x<3;x++){
    moles.push({
      x:140+x*160,
      y:220+y*140,
      r:0,
      show:false
    });
  }
}

/* ================= ì…ë ¥ ================= */
let mouse={x:0,y:0,click:false};
canvas.onmousemove=e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=(e.clientX-r.left)*(W/r.width);
  mouse.y=(e.clientY-r.top)*(H/r.height);
};
canvas.onmousedown=()=>mouse.click=true;
window.onkeyup=e=>{
  if(e.code==="Space" && state==="menu") start();
  if(e.code==="KeyR" && state==="over") start();
};

/* ================= ê²Œì„ ================= */
function start(){
  score=combo=maxCombo=0;
  elapsed=0;
  state="play";
}

function update(dt){
  if(state!=="play") return;
  elapsed+=dt;
  if(elapsed>=time){ end(); return; }

  if(Math.random()<0.02){
    const m=moles[Math.random()*moles.length|0];
    m.show=true; m.r=36;
  }

  if(mouse.click){
    mouse.click=false;
    let hit=false;
    for(const m of moles){
      const dx=mouse.x-m.x, dy=mouse.y-m.y;
      if(m.show && dx*dx+dy*dy<m.r*m.r){
        hit=true;
        m.show=false;
        combo++; maxCombo=Math.max(combo,maxCombo);
        score+=10+combo*2;
      }
    }
    if(!hit){ combo=0; score=Math.max(0,score-5); }
  }
}

function end(){
  state="over";
  probeScore();
}

/* ================= ë Œë” ================= */
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#fff";
  ctx.font="28px sans-serif";

  if(state==="menu"){
    ctx.fillText("ë‘ë”ì§€ ì¡ê¸°",240,300);
    ctx.fillText("Space ì‹œì‘",250,360);
  }

  if(state==="play"){
    ctx.fillText("ì ìˆ˜: "+score,20,40);
    ctx.fillText("ì‹œê°„: "+(time-elapsed|0),480,40);
    for(const m of moles){
      if(m.show){
        ctx.beginPath();
        ctx.arc(m.x,m.y,m.r,0,Math.PI*2);
        ctx.fillStyle="#d25f5f";
        ctx.fill();
      }
    }
  }

  if(state==="over"){
    ctx.fillText("ê²Œì„ ì˜¤ë²„",240,320);
    ctx.fillText("ì ìˆ˜: "+score,260,360);
    ctx.fillText("R ì¬ì‹œì‘",250,420);
  }
}

/* ================= ë£¨í”„ ================= */
let last=performance.now();
function loop(now){
  const dt=(now-last)/1000; last=now;
  update(dt); draw();
  requestAnimationFrame(loop);
}
loop(last);

/* ================= ì„œë²„ í†µì‹  ================= */
// TOP10 í™•ì¸
async function probeScore(){
  const res=await fetch("/api/score/probe",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({score,maxCombo})
  });
  const data=await res.json();
  if(data.qualifies){
    pendingScore={score,maxCombo};
    document.getElementById("overlay").style.display="flex";
  }
  loadBoard();
}

// ì €ì¥
document.getElementById("save").onclick=async()=>{
  const name=document.getElementById("nickname").value.trim();
  if(!name) return;
  await fetch("/api/score/submit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({...pendingScore,name})
  });
  document.getElementById("overlay").style.display="none";
  loadBoard();
};

// ë¦¬ë”ë³´ë“œ
async function loadBoard(){
  const res=await fetch("/api/leaderboard");
  const rows=await res.json();
  document.getElementById("board-body").innerHTML=
    rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td></tr>`).join("");
}
loadBoard();
</script>
</body>
</html>
