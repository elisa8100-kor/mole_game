<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë‘ë”ì§€ ì¡ê¸° (HTML5 + Leaderboard)</title>
  <style>
    :root{
      --bg:#121621; --hole:#1e2332; --mole:#d25f5f; --mole-shadow:#783737;
      --white:#ffffff; --red:#e66e6e; --hud:#eaeaf0; --accent:#ffd974;
      --glass: rgba(255,255,255,.06); --ink: rgba(0,0,0,.35);
    }
    html,body{ margin:0; height:100%; background:linear-gradient(180deg,#0f1320 0%, #121621 60%, #0f1320 100%); color:var(--hud);
      font-family: "Pretendard", "Malgun Gothic", "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; }
    .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; box-sizing:border-box; gap:24px; flex-wrap:wrap;}
    canvas{ width:min(640px,92vw); height:auto; aspect-ratio:640/720; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.05); background:var(--bg); display:block;}
    .panel{ width:min(420px,90vw); background:var(--glass); border:1px solid rgba(255,255,255,.07); border-radius:16px; padding:16px 16px 8px; box-shadow:0 12px 30px var(--ink);}
    .panel h2{ margin:0 0 12px; font-weight:700; font-size:20px;}
    .board{ width:100%; border-collapse:collapse; font-size:14px; }
    .board th,.board td{ padding:8px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left;}
    .board th{ font-weight:600; color:#bcd3ff; }
    .muted{ opacity:.8; font-size:12px; margin-top:6px;}
    .hint{ position:fixed; bottom:14px; left:50%; transform:translateX(-50%); font-size:12px; opacity:.75; user-select:none; text-align:center; line-height:1.5;}
    .toast{ position:fixed; top:12px; left:50%; transform:translateX(-50%); background:#1e2538; border:1px solid rgba(255,255,255,.08); padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.35); display:none;}
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); }
    .dialog{ width:min(420px,92vw); background:#192033; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px; box-shadow:0 18px 60px rgba(0,0,0,.55);}
    .dialog h3{ margin:0 0 12px; font-size:18px;}
    .dialog p{ margin:8px 0 12px; font-size:14px; opacity:.9;}
    .row{ display:flex; gap:10px;}
    input[type="text"]{ flex:1; background:#0f1526; border:1px solid rgba(255,255,255,.15); color:#eef3ff; padding:10px 12px; border-radius:10px; outline:none; }
    button{ background:#273150; color:#eaf1ff; border:1px solid rgba(255,255,255,.15); padding:10px 14px; border-radius:10px; cursor:pointer;}
    button:hover{ filter:brightness(1.05); }
    .danger{ background:#5a2630; border-color:#8a3948; }
    a{ color:#9ad0ff; text-decoration:none; } a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="640" height="720"></canvas>

    <!-- ë¦¬ë”ë³´ë“œ íŒ¨ë„ -->
    <div class="panel">
      <h2>ğŸ† ë¦¬ë”ë³´ë“œ (Top 10)</h2>
      <table class="board" id="board">
        <thead><tr><th>#</th><th>ë‹‰ë„¤ì„</th><th>ì ìˆ˜</th><th>ìµœëŒ€ ì½¤ë³´</th><th>ë‚ ì§œ</th></tr></thead>
        <tbody id="board-body"><tr><td colspan="5">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
      </table>
      <div class="muted">ê²Œì„ ì˜¤ë²„ í›„ Top 10ì— ë“¤ë©´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì €ì¥í•  ìˆ˜ ìˆì–´.</div>
    </div>
  </div>

  <div class="hint">ìŠ¤í˜ì´ìŠ¤ë°” ì‹œì‘ Â· ë§ˆìš°ìŠ¤ë¡œ ë‘ë”ì§€ë¥¼ í´ë¦­ Â· ê²Œì„ì˜¤ë²„ì—ì„œ Rë¡œ ì¬ì‹œì‘</div>
  <div class="toast" id="toast"></div>

  <!-- ë‹‰ë„¤ì„ ì…ë ¥ ì˜¤ë²„ë ˆì´ -->
  <div class="overlay" id="nameOverlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>ì¶•í•˜í•´! Top 10 ì§„ì… ğŸ‰</h3>
      <p>ë¦¬ë”ë³´ë“œì— í‘œì‹œí•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜. (2~12ì, íŠ¹ìˆ˜ë¬¸ì ì œí•œ)</p>
      <div class="row">
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" maxlength="12" />
        <button id="submitName">ì €ì¥</button>
        <button class="danger" id="cancelName">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • =====
    const API_BASE = "http://localhost:3000"; // í•„ìš”ì‹œ ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½

    // ====== ìœ í‹¸/ìƒìˆ˜ ======
    const W = 640, H = 720;
    const BG = "#121621", HOLE = "#1e2332", MOLE = "#d25f5f", MOLE_SHADOW = "#783737", WHITE = "#ffffff", RED = "#e66e6e", HUD = "#eaeaf0", ACCENT = "#ffd974";
    const STATE_MENU = 0, STATE_PLAY = 1, STATE_GAMEOVER = 2;
    const TAU = Math.PI * 2;
    const font = (px=28)=>`${px}px "Malgun Gothic","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif`;
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const rand = (a,b)=>Math.random()*(b-a)+a;

    // ====== ìº”ë²„ìŠ¤ ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;

    function drawTextCenter(text, size, color, cx, cy){
      ctx.font = font(size);
      ctx.fillStyle = color;
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText(text, cx, cy);
    }

    // ====== íŒŒí‹°í´ ======
    class Particle{
      constructor(x,y,color){
        const ang = rand(0,TAU), spd = rand(2,6);
        this.x=x; this.y=y; this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd;
        this.life = (rand(15,28)|0); this.color=color; this.size=(rand(2,4)|0);
      }
      update(){ this.x+=this.vx; this.y+=this.vy; this.vx*=0.96; this.vy*=0.96; this.life--; }
      draw(c){ if(this.life<=0) return; const r=Math.max(1,(this.size*this.life/28)|0); c.fillStyle=this.color; c.beginPath(); c.arc(this.x|0,this.y|0,r,0,TAU); c.fill(); }
    }

    // ====== ë‘ë”ì§€ ======
    class Mole{
      constructor(cx,cy){ this.cx=cx; this.cy=cy; this.baseR=36; this.state="hidden"; this.t=0; this.visibleDur=45; this.appearDur=12; this.disappearDur=10; this.wasHit=false; }
      spawn(vis){ this.state="appearing"; this.t=0; this.wasHit=false; this.visibleDur=Math.max(18,vis|0); }
      isClickable(){ return this.state==="appearing" || this.state==="visible"; }
      contains(x,y){ const r=this.currentRadius(), dx=x-this.cx, dy=y-this.cy; return dx*dx+dy*dy <= (r*0.9)*(r*0.9); }
      update(){
        this.t++;
        if(this.state==="appearing" && this.t>=this.appearDur){ this.state="visible"; this.t=0; }
        else if(this.state==="visible" && this.t>=this.visibleDur){ this.state="disappearing"; this.t=0; }
        else if(this.state==="disappearing" && this.t>=this.disappearDur){ this.state="hidden"; this.t=0; }
      }
      hit(){ if(this.isClickable() && !this.wasHit){ this.wasHit=true; this.state="disappearing"; this.t=0; return true; } return false; }
      currentRadius(){
        if(this.state==="appearing"){ const k=this.t/this.appearDur; return (this.baseR*(0.2+0.8*k))|0; }
        if(this.state==="visible"){ const pulse=0.04*Math.sin(this.t*0.35); return (this.baseR*(1.0+pulse))|0; }
        if(this.state==="disappearing"){ const k=1-(this.t/this.disappearDur); return (this.baseR*(0.2+0.8*k))|0; }
        return (this.baseR*0.2)|0;
      }
      draw(c){
        const shadowR=(this.baseR*1.15)|0;
        c.fillStyle = HOLE; c.beginPath(); c.arc(this.cx,this.cy,shadowR,0,TAU); c.fill();
        if(this.state!=="hidden"){
          const r=this.currentRadius();
          c.fillStyle=MOLE_SHADOW; c.beginPath(); c.arc(this.cx,this.cy+3,r,0,TAU); c.fill();
          c.fillStyle=MOLE; c.beginPath(); c.arc(this.cx,this.cy,r,0,TAU); c.fill();
          const eyeR=Math.max(2,(r/8)|0); c.fillStyle="#1e1e1e";
          c.beginPath(); c.arc(this.cx-(r/3)|0,this.cy-(r/5)|0,eyeR,0,TAU); c.fill();
          c.beginPath(); c.arc(this.cx+(r/3)|0,this.cy-(r/5)|0,eyeR,0,TAU); c.fill();
          const noseR=Math.max(2,(r/6)|0); c.fillStyle="#ffaaaa";
          c.beginPath(); c.arc(this.cx,this.cy,noseR,0,TAU); c.fill();
        }
      }
    }

    // ====== ê²Œì„ ======
    class Game{
      constructor(){ this.state=STATE_MENU; this.timeLimit=30; this.highScore=Number(localStorage.getItem("wam_high_score")||0); this.reset(); }
      reset(){
        const marginX=80, marginY=160;
        const gapX=((W-marginX*2)/2)|0, gapY=((H-marginY-120)/2)|0;
        const centers=[];
        for(let gy=0;gy<3;gy++) for(let gx=0;gx<3;gx++){ centers.push([marginX+gx*gapX+40, marginY+gy*gapY+40]); }
        this.moles=centers.map(([x,y])=>new Mole(x,y));
        this.particles=[]; this.score=0; this.combo=0; this.maxCombo=0;
        this.elapsed=0; this.spawnTimer=0; this.baseVisibleFrames=50; this.visibleFrames=this.baseVisibleFrames; this.spawnInterval=0.9;
      }
      addParticles(x,y,color,n=18){ for(let i=0;i<n;i++) this.particles.push(new Particle(x,y,color)); }
      updateDifficulty(){ const p=Math.min(1,this.elapsed/this.timeLimit); this.visibleFrames=Math.max(18,(this.baseVisibleFrames-22*p)|0); this.spawnInterval=Math.max(0.35, 0.9-0.5*p); }
      spawnLogic(){ const hidden=this.moles.filter(m=>m.state==="hidden"); if(hidden.length){ hidden[(Math.random()*hidden.length)|0].spawn(this.visibleFrames); } }
    }

    // ====== ì…ë ¥ ======
    let mouse={x:0, y:0, pressed:false, justPressed:false};
    canvas.addEventListener('mousemove', e=>{
      const rect=canvas.getBoundingClientRect(); const sx=rect.width/canvas.width, sy=rect.height/canvas.height;
      mouse.x=(e.clientX-rect.left)/sx; mouse.y=(e.clientY-rect.top)/sy;
    });
    canvas.addEventListener('mousedown', ()=>{ mouse.pressed=true; mouse.justPressed=true; });
    window.addEventListener('mouseup', ()=>{ mouse.pressed=false; });

    let keyDown={};
    // >>> íŒíŠ¸ ë©”ì‹œì§€ ì „ì—­
    let top10HintMessage = "";

    window.addEventListener('keydown', e=>{
      keyDown[e.code]=true;
      if(e.code==='Space' && game.state===STATE_MENU){
        top10HintMessage = "";        // ì‹œì‘ ì‹œ íŒíŠ¸ ì´ˆê¸°í™”
        game.reset(); game.state=STATE_PLAY;
      } else if(e.code==='KeyR' && game.state===STATE_GAMEOVER){
        top10HintMessage = "";        // ì¬ì‹œì‘ ì‹œ íŒíŠ¸ ì´ˆê¸°í™”
        game.reset(); game.state=STATE_PLAY;
      }
    });
    window.addEventListener('keyup', e=>{ keyDown[e.code]=false; });

    // ====== ë£¨í”„ ======
    const game=new Game(); let last=performance.now();
    function update(dt){
      if(game.state===STATE_PLAY){
        game.elapsed+=dt; game.spawnTimer+=dt; game.updateDifficulty();
        if(game.spawnTimer>=game.spawnInterval){ game.spawnTimer=0; game.spawnLogic(); }
        for(const m of game.moles) m.update();
        const next=[]; for(const p of game.particles){ p.update(); if(p.life>0) next.push(p); } game.particles=next;

        if(mouse.justPressed){
          let hit=false;
          for(const m of game.moles){
            if(m.contains(mouse.x,mouse.y) && m.hit()){
              hit=true; game.score += 10 + game.combo*2; game.combo += 1; game.maxCombo = Math.max(game.maxCombo, game.combo);
              game.addParticles(mouse.x,mouse.y,ACCENT,20);
            }
          }
          if(!hit){ game.combo=0; game.score=Math.max(0, game.score-5); }
        }

        if(game.elapsed>=game.timeLimit){
          game.state=STATE_GAMEOVER;
          if(game.score>game.highScore){ game.highScore=game.score; localStorage.setItem("wam_high_score", String(game.highScore)); }
          // ì„œë²„ì— ì ìˆ˜ ì „ì†¡ â†’ Top10 ì—¬ë¶€ í™•ì¸ â†’ ë‹‰ë„¤ì„ ìˆ˜ì§‘ or íŒíŠ¸ ë©”ì‹œì§€
          probeAndMaybeAskName(game.score, game.maxCombo);
        }
      }
      mouse.justPressed=false;
    }

    function draw(){
      ctx.fillStyle=BG; ctx.fillRect(0,0,W,H);
      if(game.state===STATE_MENU){
        drawTextCenter("ë‘ë”ì§€ ì¡ê¸°", 64, WHITE, W/2, H/2-80);
        drawTextCenter("ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ì‹œì‘", 32, WHITE, W/2, H/2+40);
        drawTextCenter(`ìµœëŒ€ ì ìˆ˜: ${game.highScore}`, 24, HUD, W/2, H/2+90);
      }else if(game.state===STATE_PLAY){
        for(const m of game.moles) m.draw(ctx);
        for(const p of game.particles) p.draw(ctx);
        drawTextCenter(`ì ìˆ˜: ${game.score}`, 32, WHITE, 100, 40);
        drawTextCenter(`ì½¤ë³´: ${game.combo}`, 32, WHITE, 300, 40);
        const remain = Math.max(0, Math.floor(game.timeLimit - game.elapsed));
        drawTextCenter(`ë‚¨ì€ ì‹œê°„: ${remain}`, 32, WHITE, 520, 40);
      }else if(game.state===STATE_GAMEOVER){
        drawTextCenter("ê²Œì„ ì˜¤ë²„", 64, RED, W/2, H/2-60);
        drawTextCenter(`ìµœì¢… ì ìˆ˜: ${game.score}`, 40, WHITE, W/2, H/2);
        drawTextCenter(`ìµœëŒ€ ì ìˆ˜: ${game.highScore}`, 32, WHITE, W/2, H/2+50);
        drawTextCenter("R í‚¤ë¥¼ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘", 32, WHITE, W/2, H/2+120);

        // >>> Top10 ì‹¤íŒ¨ ì•ˆë‚´ ë¬¸êµ¬ê°€ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ í‘œì‹œ
        if (top10HintMessage) {
          drawTextCenter(top10HintMessage, 20, "#eaeaf0", W/2, H/2+160);
        }
      }
    }

    function loop(now){
      const dt=(now-last)/1000; last=now; update(dt); draw(); requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ====== ë¦¬ë”ë³´ë“œ UI ======
    const boardBody = document.getElementById('board-body');
    async function refreshLeaderboard(){
      try{
        const res = await fetch(`${API_BASE}/api/leaderboard`);
        const data = await res.json();
        renderBoard(data);
      }catch(e){
        boardBody.innerHTML = `<tr><td colspan="5">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.</td></tr>`;
      }
    }
    function renderBoard(rows){
      if(!rows || rows.length===0){
        boardBody.innerHTML = `<tr><td colspan="5">ì•„ì§ ë“±ë¡ëœ ì ìˆ˜ê°€ ì—†ì–´.</td></tr>`;
        return;
      }
      boardBody.innerHTML = rows.map((r,i)=>{
        const when = new Date(r.created_at).toLocaleDateString();
        const safeName = escapeHTML(r.name);
        return `<tr><td>${i+1}</td><td>${safeName}</td><td>${r.score}</td><td>${r.maxCombo||0}</td><td>${when}</td></tr>`;
      }).join("");
    }
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ====== ì ìˆ˜ ì œì¶œ/í”„ë¡œë¸Œ ======
    const nameOverlay = document.getElementById('nameOverlay');
    const nicknameInput = document.getElementById('nickname');
    const submitNameBtn = document.getElementById('submitName');
    const cancelNameBtn = document.getElementById('cancelName');
    let pendingScore = null;

    function showToast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.style.display='block';
      setTimeout(()=>{ t.style.display='none'; }, 1800);
    }

    async function probeAndMaybeAskName(score, maxCombo){
      try{
        const res = await fetch(`${API_BASE}/api/score/probe`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ score, maxCombo })
        });
        const data = await res.json();
        if(data.qualifies){
          top10HintMessage = ""; // Top10 ì§„ì… ì‹œ íŒíŠ¸ ì´ˆê¸°í™”
          pendingScore = { score, maxCombo };
          nicknameInput.value = "";
          nameOverlay.style.display = "flex";
          nicknameInput.focus();
        }else{
          // >>> Top10 ì‹¤íŒ¨ ì‹œ ì›í•˜ëŠ” ë¬¸êµ¬ ì„¸íŒ… + í† ìŠ¤íŠ¸
          top10HintMessage = "ë­í‚¹ìœ„ë¡œ ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì…ã…•";
          showToast(top10HintMessage);
        }
        refreshLeaderboard();
      }catch(e){
        showToast('ì ìˆ˜ ì œì¶œ ì‹¤íŒ¨');
      }
    }

    function validateNickname(name){
      // 2~12ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì/ê³µë°±/ì–¸ë”ìŠ¤ì½”ì–´/í•˜ì´í”ˆ
      return /^[\p{L}0-9 _-]{2,12}$/u.test(name);
    }

    submitNameBtn.addEventListener('click', async ()=>{
      const name = nicknameInput.value.trim();
      if(!validateNickname(name)){
        showToast('ë‹‰ë„¤ì„ í˜•ì‹ì´ ë§ì§€ ì•Šì•„ (2~12ì, íŠ¹ìˆ˜ë¬¸ì ì œí•œ)');
        return;
      }
      if(!pendingScore){ nameOverlay.style.display='none'; return; }
      try{
        const res = await fetch(`${API_BASE}/api/score/submit`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, score: pendingScore.score, maxCombo: pendingScore.maxCombo })
        });
        const data = await res.json();
        nameOverlay.style.display='none';
        showToast('ë¦¬ë”ë³´ë“œì— ì €ì¥ ì™„ë£Œ!');
        pendingScore = null;
        renderBoard(data.leaderboard || []);
      }catch(e){
        showToast('ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´');
      }
    });
    cancelNameBtn.addEventListener('click', ()=>{
      pendingScore = null;
      nameOverlay.style.display = 'none';
      showToast('ì €ì¥ì„ ì·¨ì†Œí–ˆì–´');
    });

    // ì²« ë¡œë“œì‹œ ë¦¬ë”ë³´ë“œ ê°€ì ¸ì˜¤ê¸°
    refreshLeaderboard();
  </script>
</body>
</html>
